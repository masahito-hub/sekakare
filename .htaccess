# =================================================================
# .htaccess - セキュリティとパフォーマンス設定
# Xserver対応版
# =================================================================

# -----------------------------------------------------------------
# 1. HTTPS強制リダイレクト (HTTP → HTTPS) - Xserver対応版
# -----------------------------------------------------------------
<IfModule mod_rewrite.c>
    RewriteEngine On

    # Xserver環境用の複数条件でHTTPSチェック
    # X-Forwarded-Protoヘッダーをチェック（プロキシ経由の場合）
    RewriteCond %{HTTP:X-Forwarded-Proto} !https [NC,OR]
    # HTTPSサーバー変数をチェック
    RewriteCond %{HTTPS} off [OR]
    # サーバーポートをチェック（HTTP:80の場合）
    RewriteCond %{SERVER_PORT} ^80$
    # 上記のいずれかに該当する場合はHTTPSにリダイレクト
    RewriteRule ^(.*)$ https://%{HTTP_HOST}/$1 [R=301,L]

    # www付きURLを www無しにリダイレクト（オプション）
    # RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
    # RewriteRule ^(.*)$ https://%1/$1 [L,R=301]
</IfModule>

# -----------------------------------------------------------------
# 2. セキュリティヘッダー設定
# -----------------------------------------------------------------
<IfModule mod_headers.c>
    # クリックジャッキング対策
    Header always set X-Frame-Options "DENY"

    # MIME タイプのスニッフィング防止
    Header always set X-Content-Type-Options "nosniff"

    # XSS フィルター有効化
    Header always set X-XSS-Protection "1; mode=block"

    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # HSTS (HTTP Strict Transport Security) - 1年間
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # Content Security Policy (基本設定 + Google Maps API + Google Analytics対応)
    # Google Places API (New)のためにworker-srcとその他の必要なドメインを追加
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com https://maps.googleapis.com https://maps.gstatic.com https://www.googletagmanager.com https://www.google-analytics.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com https://maps.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: https: blob: https://www.google-analytics.com https://www.googletagmanager.com https://maps.googleapis.com https://maps.gstatic.com; connect-src 'self' https://maps.googleapis.com https://maps.gstatic.com https://www.google-analytics.com https://www.googletagmanager.com https://region1.google-analytics.com https://places.googleapis.com; frame-src 'self' https://www.google.com https://maps.google.com; worker-src 'self' blob:; child-src 'self' blob:"

    # 権限ポリシー（旧Feature-Policy） - geolocationはセルフドメインで許可
    Header always set Permissions-Policy "geolocation=(self), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=()"
</IfModule>

# -----------------------------------------------------------------
# 3. ファイル圧縮設定 (GZIP圧縮)
# -----------------------------------------------------------------
<IfModule mod_deflate.c>
    # 圧縮を有効化
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/ld+json
    AddOutputFilterByType DEFLATE application/x-font-ttf
    AddOutputFilterByType DEFLATE application/x-font-opentype
    AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
    AddOutputFilterByType DEFLATE image/svg+xml
    AddOutputFilterByType DEFLATE image/x-icon

    # 古いブラウザ対応
    BrowserMatch ^Mozilla/4 gzip-only-text/html
    BrowserMatch ^Mozilla/4\.0[678] no-gzip
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
    Header append Vary User-Agent
</IfModule>

# -----------------------------------------------------------------
# 4. ブラウザキャッシュ設定
# -----------------------------------------------------------------
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresDefault "access plus 1 month"

    # HTML
    ExpiresByType text/html "access plus 0 seconds"

    # Data
    ExpiresByType text/xml "access plus 0 seconds"
    ExpiresByType application/xml "access plus 0 seconds"
    ExpiresByType application/json "access plus 0 seconds"

    # Feed
    ExpiresByType application/rss+xml "access plus 1 hour"
    ExpiresByType application/atom+xml "access plus 1 hour"

    # CSS と JavaScript
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType text/javascript "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"

    # 画像
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresByType image/vnd.microsoft.icon "access plus 1 year"

    # フォント
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/otf "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"

    # その他
    ExpiresByType text/x-cross-domain-policy "access plus 1 week"
</IfModule>

# Cache-Control ヘッダー
<IfModule mod_headers.c>
    # 1年間キャッシュ（静的リソース）
    <FilesMatch "\.(ico|pdf|flv|jpg|jpeg|png|gif|webp|svg|js|css|swf|ttf|otf|woff|woff2|eot)$">
        Header set Cache-Control "max-age=31536000, public, immutable"
    </FilesMatch>

    # キャッシュ無効（動的コンテンツ）
    <FilesMatch "\.(html|php)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires 0
    </FilesMatch>
</IfModule>

# -----------------------------------------------------------------
# 5. アクセス制限（セキュリティファイルの保護）
# -----------------------------------------------------------------

# .htaccess と .htpasswd ファイルへのアクセス拒否
<Files ~ "^\.ht">
    Order allow,deny
    Deny from all
    Satisfy all
</Files>

# .git フォルダへのアクセス拒否
<IfModule mod_rewrite.c>
    RewriteRule ^\.git/ - [F,L]
</IfModule>

# 環境変数ファイルへのアクセス拒否
<FilesMatch "^\.env">
    Order allow,deny
    Deny from all
</FilesMatch>

# バックアップファイルへのアクセス拒否
<FilesMatch "\.(bak|backup|sql|old|orig|original|php~|php_bak|save|swp)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# 設定ファイルへのアクセス拒否
<FilesMatch "\.(ini|log|sh|inc|bak|config)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# composer関連ファイルへのアクセス拒否
<FilesMatch "(composer\.(json|lock)|package\.(json|lock))$">
    Order allow,deny
    Deny from all
</FilesMatch>

# README, ライセンス、その他のドキュメントファイルへのアクセス拒否
<FilesMatch "(README|readme|LICENSE|license|CHANGELOG|changelog)\.(txt|md)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# デバッグツールへのアクセス制限（本番環境ではローカルホストのみ許可）
# 注意: 開発環境では以下をコメントアウトしてください
# <Files "heatmap-debug.html">
#     Require ip 127.0.0.1
# </Files>

# -----------------------------------------------------------------
# 6. その他のセキュリティ設定
# -----------------------------------------------------------------

# ディレクトリ一覧の無効化
Options -Indexes

# サーバー署名の非表示
ServerSignature Off

# ETags の無効化（プライバシー保護）
<IfModule mod_headers.c>
    Header unset ETag
</IfModule>
FileETag None

# -----------------------------------------------------------------
# 7. 文字エンコーディング設定
# -----------------------------------------------------------------
AddDefaultCharset UTF-8

<IfModule mod_mime.c>
    AddCharset UTF-8 .html .css .js .xml .json .rss .atom
</IfModule>

# -----------------------------------------------------------------
# 8. MIME タイプ設定
# -----------------------------------------------------------------
<IfModule mod_mime.c>
    AddType text/css .css
    AddType text/javascript .js
    AddType application/javascript .js
    AddType application/json .json
    AddType application/xml .xml
    AddType image/svg+xml .svg .svgz
    AddType image/webp .webp
    AddType font/woff .woff
    AddType font/woff2 .woff2
    AddType application/vnd.ms-fontobject .eot
    AddType font/ttf .ttf
    AddType font/otf .otf
</IfModule>

# -----------------------------------------------------------------
# 9. エラーページ設定（オプション）
# -----------------------------------------------------------------
# ErrorDocument 400 /error/400.html
# ErrorDocument 401 /error/401.html
# ErrorDocument 403 /error/403.html
# ErrorDocument 404 /error/404.html
# ErrorDocument 500 /error/500.html
# ErrorDocument 503 /error/503.html

# =================================================================
# EOF
# =================================================================
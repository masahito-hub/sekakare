<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ティッカー機能テスト - セカカレ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #ff8c00;
            margin-bottom: 30px;
        }

        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group h3 {
            margin-bottom: 10px;
            color: #333;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #ff8c00;
            color: white;
            font-size: 14px;
            transition: background 0.3s;
        }

        button:hover {
            background: #ff6b00;
        }

        button.secondary {
            background: #6c757d;
        }

        button.secondary:hover {
            background: #5a6268;
        }

        .status-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .status-item {
            padding: 10px;
            margin: 10px 0;
            background: #f8f9fa;
            border-left: 3px solid #ff8c00;
            border-radius: 4px;
        }

        .preview-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        iframe {
            width: 100%;
            height: 600px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .test-section {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 2px solid #ffc107;
        }

        .test-section h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .test-case {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 4px;
        }

        .test-case code {
            background: #f8f9fa;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
        }

        .success {
            color: green;
        }

        .danger {
            color: red;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🍛 ティッカー機能テストページ</h1>

        <div class="control-panel">
            <div class="control-group">
                <h3>キャッシュ制御</h3>
                <button id="clearTickerCache">ティッカーキャッシュをクリア</button>
                <button id="showCacheStatus" class="secondary">キャッシュ状態を表示</button>
                <div id="cacheStatus" style="margin-top: 10px;"></div>
            </div>

            <div class="control-group">
                <h3>ページ制御</h3>
                <button id="reloadFrame">プレビューをリロード</button>
                <button id="openNewTab" class="secondary">新しいタブで開く</button>
            </div>
        </div>

        <div class="test-section">
            <h3>🔒 セキュリティテスト</h3>
            <div class="test-case">
                <strong>URL検証テスト:</strong>
                <ul>
                    <li>無効なURL (javascript:alert('XSS')) → <span id="test-invalid-url">未テスト</span></li>
                    <li>有効なURL (https://example.com) → <span id="test-valid-url">未テスト</span></li>
                    <li>データURL (data:text/html,test) → <span id="test-data-url">未テスト</span></li>
                </ul>
            </div>
            <div class="test-case">
                <strong>XSS対策テスト:</strong>
                <ul>
                    <li>HTMLタグエスケープ (&lt;script&gt;alert&lt;/script&gt;) → <span id="test-xss-escape">未テスト</span></li>
                </ul>
            </div>
            <button id="runSecurityTests">セキュリティテストを実行</button>
        </div>

        <div class="status-panel">
            <h3>現在のステータス</h3>
            <div class="status-item">
                <strong>ティッカーキャッシュ:</strong> <span id="currentCacheStatus">確認中...</span>
            </div>
        </div>

        <div class="preview-container">
            <h3>プレビュー</h3>
            <iframe id="preview" src="index.html"></iframe>
        </div>
    </div>

    <script>
        // ステータス更新
        function updateStatus() {
            // デバッグモード関連を削除、キャッシュ状態のみ更新
            const cache = localStorage.getItem('sekakare_ticker_cache');
            if (cache) {
                try {
                    const data = JSON.parse(cache);
                    const age = Date.now() - data.timestamp;
                    const minutes = Math.floor(age / 60000);
                    document.getElementById('currentCacheStatus').textContent =
                        `${data.items.length}件 (${minutes}分前に取得)`;
                } catch (e) {
                    document.getElementById('currentCacheStatus').textContent = '無効なキャッシュ';
                }
            } else {
                document.getElementById('currentCacheStatus').textContent = 'キャッシュなし';
            }
        }

        // キャッシュクリア
        document.getElementById('clearTickerCache').addEventListener('click', () => {
            localStorage.removeItem('sekakare_ticker_cache');
            document.getElementById('cacheStatus').innerHTML =
                '<span class="success">キャッシュをクリアしました</span>';
            updateStatus();
        });

        // キャッシュ状態表示
        document.getElementById('showCacheStatus').addEventListener('click', () => {
            const cache = localStorage.getItem('sekakare_ticker_cache');
            if (cache) {
                const data = JSON.parse(cache);
                document.getElementById('cacheStatus').innerHTML =
                    `<code>アイテム数: ${data.items.length}, タイムスタンプ: ${new Date(data.timestamp).toLocaleString('ja-JP')}</code>`;
            } else {
                document.getElementById('cacheStatus').innerHTML =
                    '<code>キャッシュが存在しません</code>';
            }
        });

        // フレームリロード
        document.getElementById('reloadFrame').addEventListener('click', () => {
            document.getElementById('preview').src = 'index.html?' + Date.now();
        });

        // 新しいタブで開く
        document.getElementById('openNewTab').addEventListener('click', () => {
            window.open('index.html', '_blank');
        });

        // セキュリティテスト実行
        document.getElementById('runSecurityTests').addEventListener('click', () => {
            // ticker.jsの関数をテスト（実際の環境では読み込まれているはず）
            if (typeof isValidUrl === 'function') {
                // URL検証テスト
                const invalidUrl = isValidUrl('javascript:alert("XSS")');
                document.getElementById('test-invalid-url').textContent = !invalidUrl ? '✅ ブロック' : '❌ 通過';
                document.getElementById('test-invalid-url').className = !invalidUrl ? 'success' : 'danger';

                const validUrl = isValidUrl('https://example.com');
                document.getElementById('test-valid-url').textContent = validUrl ? '✅ 通過' : '❌ ブロック';
                document.getElementById('test-valid-url').className = validUrl ? 'success' : 'danger';

                const dataUrl = isValidUrl('data:text/html,test');
                document.getElementById('test-data-url').textContent = !dataUrl ? '✅ ブロック' : '❌ 通過';
                document.getElementById('test-data-url').className = !dataUrl ? 'success' : 'danger';
            } else {
                alert('ticker.jsが読み込まれていません');
            }

            // XSSエスケープテスト
            if (typeof escapeHtml === 'function') {
                const escaped = escapeHtml('<script>alert("XSS")</script>');
                const isEscaped = !escaped.includes('<script>');
                document.getElementById('test-xss-escape').textContent = isEscaped ? '✅ エスケープ成功' : '❌ エスケープ失敗';
                document.getElementById('test-xss-escape').className = isEscaped ? 'success' : 'danger';
            }
        });

        // ticker.js関数をインポート（テスト用）
        const script = document.createElement('script');
        script.src = 'assets/js/ticker.js';
        document.head.appendChild(script);

        // 初期ステータス表示
        updateStatus();
        setInterval(updateStatus, 5000); // 5秒ごとに更新
    </script>
</body>
</html>
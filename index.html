<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒ¬ãƒ¼ãƒ­ã‚° - ã‚ãªãŸã®ã‚«ãƒ¬ãƒ¼ä½“é¨“ã‚’è¨˜éŒ²ã—ã‚ˆã†</title>
    <meta name="description" content="é£Ÿã¹ãŸã‚«ãƒ¬ãƒ¼ã‚’åœ°å›³ä¸Šã«è¨˜éŒ²ã—ã¦ã€ã‚ãªãŸã ã‘ã®ã‚«ãƒ¬ãƒ¼ãƒãƒƒãƒ—ã‚’ä½œæˆã€‚å…¨å›½ã®ã‚«ãƒ¬ãƒ¼åº—ã‚’ç™ºè¦‹ã—ã¦ã€ã‚«ãƒ¬ãƒ¼å·¡ã‚Šã‚’æ¥½ã—ã‚‚ã†ï¼">
    <meta name="keywords" content="ã‚«ãƒ¬ãƒ¼,ã‚°ãƒ«ãƒ¡,åœ°å›³,ãƒ­ã‚°,è¨˜éŒ²,ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://your-domain.com/">
    <meta property="og:title" content="ã‚«ãƒ¬ãƒ¼ãƒ­ã‚° - ã‚ãªãŸã®ã‚«ãƒ¬ãƒ¼ä½“é¨“ã‚’è¨˜éŒ²ã—ã‚ˆã†">
    <meta property="og:description" content="é£Ÿã¹ãŸã‚«ãƒ¬ãƒ¼ã‚’åœ°å›³ä¸Šã«è¨˜éŒ²ã—ã¦ã€ã‚ãªãŸã ã‘ã®ã‚«ãƒ¬ãƒ¼ãƒãƒƒãƒ—ã‚’ä½œæˆ">
    <meta property="og:image" content="https://your-domain.com/assets/images/og-image.jpg">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://your-domain.com/">
    <meta property="twitter:title" content="ã‚«ãƒ¬ãƒ¼ãƒ­ã‚°">
    <meta property="twitter:description" content="é£Ÿã¹ãŸã‚«ãƒ¬ãƒ¼ã‚’åœ°å›³ä¸Šã«è¨˜éŒ²ã—ã¦ã€ã‚ãªãŸã ã‘ã®ã‚«ãƒ¬ãƒ¼ãƒãƒƒãƒ—ã‚’ä½œæˆ">
    <meta property="twitter:image" content="https://your-domain.com/assets/images/og-image.jpg">
    
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-XXXXXXXXXX');
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ff8c00, #ffa500);
            min-height: 100vh;
        }
        
        .header {
            background: rgba(255, 140, 0, 0.9);
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .container {
            max-width: 100%;
            margin: 0;
            background: white;
        }
        
        #map {
            height: 70vh;
            width: 100%;
        }
        
        .controls {
            padding: 15px;
            background: white;
            border-top: 2px solid #ff8c00;
        }
        
        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #ff8c00;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            margin-bottom: 15px;
        }
        
        .search-box:focus {
            border-color: #ff6b00;
            box-shadow: 0 0 10px rgba(255, 140, 0, 0.3);
        }
        
        .log-section {
            padding: 15px;
            background: #fafafa;
        }
        
        .log-title {
            font-size: 18px;
            color: #ff6b00;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        
        .log-count {
            background: #ff8c00;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 14px;
            margin-left: 10px;
        }
        
        .log-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .log-item {
            background: white;
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 8px;
            border-left: 4px solid #ff8c00;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .log-item-name {
            font-weight: bold;
            color: #333;
        }
        
        .log-item-date {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }
        
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 90%;
            width: 350px;
        }
        
        .popup h3 {
            color: #ff6b00;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .popup-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            flex: 1;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #ff8c00;
            color: white;
        }
        
        .btn-primary:hover {
            background: #ff6b00;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .debug-info {
            padding: 10px;
            background: #f0f8ff;
            border: 1px solid #add8e6;
            margin: 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 20px;
            }
            
            #map {
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ› ã‚»ã‚«ã‚«ãƒ¬</h1>
        <p>ä¸–ç•Œã‚’ã‚«ãƒ¬ãƒ¼ã§å¡—ã‚Šå°½ããã†ï¼ã‚ãªãŸã®ã‚«ãƒ¬ãƒ¼ä½“é¨“ã‚’è¨˜éŒ²</p>
    </div>
    
    <div class="debug-info" id="debugInfo">
        <strong>èµ·å‹•ä¸­...</strong> ã‚«ãƒ¬ãƒ¼åº—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™
    </div>
    
    <div class="container">
        <div id="map"></div>
        
        <div class="controls">
            <input type="text" class="search-box" placeholder="ğŸ” ã‚«ãƒ¬ãƒ¼åº—åã‚„åœ°åŸŸã‚’æ¤œç´¢... (ä¾‹: æ–°å®¿ ã‚«ãƒ¬ãƒ¼ã€ã‚¹ãƒ¼ãƒ—ã‚«ãƒ¬ãƒ¼)" id="searchBox">
            <small style="color: #666;">Enterã‚­ãƒ¼ã§æ¤œç´¢ | åœ°å›³ã‚’å‹•ã‹ã™ã¨å‘¨è¾ºã®ã‚«ãƒ¬ãƒ¼åº—ã‚’è‡ªå‹•æ¤œç´¢</small>
        </div>
        
        <div class="log-section">
            <div class="log-title">
                é£Ÿã¹ãŸã‚«ãƒ¬ãƒ¼
                <span class="log-count" id="logCount">0</span>
            </div>
            <div class="log-list" id="logList">
                <div class="loading">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚åœ°å›³ä¸Šã®ã‚«ãƒ¬ãƒ¼åº—ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è¨˜éŒ²ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼</div>
            </div>
        </div>
    </div>
    
    <div class="popup-overlay" id="popupOverlay">
        <div class="popup">
            <h3 id="popupTitle">åº—èˆ—å</h3>
            <p id="popupAddress">ä½æ‰€</p>
            <div class="popup-buttons">
                <button class="btn btn-primary" id="btnAte">ğŸ› é£Ÿã¹ãŸï¼</button>
                <button class="btn btn-secondary" id="btnDetails">è©³ç´°ã‚’è¦‹ã‚‹</button>
                <button class="btn btn-secondary" id="btnClose">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // APIã‚­ãƒ¼ï¼ˆæœ¬ç•ªå…¬é–‹æ™‚ã¯ç’°å¢ƒå¤‰æ•°ã«ç§»è¡Œï¼‰
   const API_KEY = 'YOUR_API_KEY_HERE';
        
        let map;
        let currentPlace = null;
        let curryLogs = JSON.parse(localStorage.getItem('curryLogs') || '[]');
        let heatmapData = JSON.parse(localStorage.getItem('heatmapData') || '{}');
        let markers = [];
        let heatmapCircles = [];
        let achievements = JSON.parse(localStorage.getItem('achievements') || '{}');
        let searchTimeout;
        
        // åœ°å›³ã‚’åˆæœŸåŒ–
        function initMap() {
            console.log('åœ°å›³ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™...');
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ï¼ˆæ±äº¬é§…ï¼‰
            const defaultLocation = { lat: 35.6812, lng: 139.7671 };
            
            try {
                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 15,
                    center: defaultLocation,
                    styles: [
                        {
                            "featureType": "poi",
                            "elementType": "labels.text",
                            "stylers": [{ "visibility": "off" }]
                        }
                    ]
                });
                
                console.log('åœ°å›³ãŒä½œæˆã•ã‚Œã¾ã—ãŸ');
                
                // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã‚’æœ‰åŠ¹åŒ–
                document.getElementById('searchBox').disabled = false;
                
                // åœ°å›³ç§»å‹•æ™‚ã®è‡ªå‹•æ¤œç´¢ã‚’è¨­å®š
                setupAutoSearch();
                
                // å‘¨è¾ºã®ã‚«ãƒ¬ãƒ¼åº—ã‚’æ¤œç´¢
                console.log('å‘¨è¾ºã®ã‚«ãƒ¬ãƒ¼åº—ã‚’æ¤œç´¢ã—ã¾ã™');
                autoSearchCurryShops(defaultLocation);
                
                // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚’è¡¨ç¤º
                displayHeatmap();
                
                // ãƒ­ã‚°ã‚’è¡¨ç¤º
                displayLogs();
                
                // å®Ÿç¸¾ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–
                initAchievements();
                
            } catch (error) {
                console.error('åœ°å›³åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                updateDebugInfo('âŒ åœ°å›³ã®åˆæœŸåŒ–ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }
        
        // è‡ªå‹•æ¤œç´¢ã®è¨­å®š
        function setupAutoSearch() {
            map.addListener('idle', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const center = map.getCenter();
                    if (center) {
                        console.log('åœ°å›³ç§»å‹•æ¤œå‡º - å‘¨è¾ºã®ã‚«ãƒ¬ãƒ¼åº—ã‚’æ¤œç´¢ä¸­...');
                        autoSearchCurryShops(center);
                    }
                }, 500);
            });
        }
        
        // åœ°å›³ç§»å‹•æ™‚ã®è‡ªå‹•æ¤œç´¢é–¢æ•°ï¼ˆGAã‚¤ãƒ™ãƒ³ãƒˆä»˜ãï¼‰
        function autoSearchCurryShops(location) {
            updateDebugInfo('<strong>ğŸ—ºï¸ åœ°å›³ç§»å‹•æ¤œå‡º</strong> ã“ã®å‘¨è¾ºã®ã‚«ãƒ¬ãƒ¼åº—ã‚’è‡ªå‹•æ¤œç´¢ä¸­...');
            
            // locationã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰æ­£ã—ã„åº§æ¨™ã‚’å–å¾—
            let lat, lng;
            if (typeof location.lat === 'function') {
                lat = location.lat();
                lng = location.lng();
            } else {
                lat = location.lat;
                lng = location.lng;
            }
            
            console.log('æ¤œç´¢åº§æ¨™:', lat, lng);
            
            // Google Analytics - åœ°å›³ç§»å‹•ã‚¤ãƒ™ãƒ³ãƒˆ
            gtag('event', 'map_moved', {
                'event_category': 'user_action',
                'latitude': lat.toFixed(4),
                'longitude': lng.toFixed(4),
                'event_label': `${lat.toFixed(4)},${lng.toFixed(4)}`,
                'custom_parameter_1': 'map_interaction'
            });
            
            const request = {
                textQuery: 'ã‚«ãƒ¬ãƒ¼',
                fields: ['displayName', 'location', 'businessStatus', 'formattedAddress'],
                locationBias: { lat: lat, lng: lng },
                maxResultCount: 20
            };
            
            google.maps.places.Place.searchByText(request).then((response) => {
                if (response.places && response.places.length > 0) {
                    clearMarkers();
                    response.places.forEach(place => createNewMarker(place));
                    
                    // Google Analytics - è‡ªå‹•æ¤œç´¢æˆåŠŸã‚¤ãƒ™ãƒ³ãƒˆ
                    gtag('event', 'auto_search_success', {
                        'event_category': 'search_result',
                        'result_count': response.places.length,
                        'latitude': lat.toFixed(4),
                        'longitude': lng.toFixed(4),
                        'event_label': `è‡ªå‹•æ¤œç´¢ - ${response.places.length}ä»¶`,
                        'custom_parameter_1': 'auto_search'
                    });
                    
                    updateDebugInfo(`<strong>âœ… è‡ªå‹•æ¤œç´¢å®Œäº†ï¼</strong> ã“ã®å‘¨è¾ºã§${response.places.length}ä»¶ã®ã‚«ãƒ¬ãƒ¼åº—ã‚’ç™ºè¦‹`);
                } else {
                    updateDebugInfo('<strong>âš ï¸ ã“ã®å‘¨è¾ºã«ã¯ã‚«ãƒ¬ãƒ¼åº—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</strong> åœ°å›³ã‚’ç§»å‹•ã—ã¦ã¿ã¦ãã ã•ã„');
                }
            }).catch((error) => {
                console.error('è‡ªå‹•æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                updateDebugInfo(`<strong>âŒ è‡ªå‹•æ¤œç´¢ã‚¨ãƒ©ãƒ¼:</strong> ${error.message}`);
            });
        }
        
        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢æ©Ÿèƒ½ï¼ˆGAã‚¤ãƒ™ãƒ³ãƒˆä»˜ãï¼‰
        function searchCurryByKeyword(keyword) {
            console.log('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ä¸­:', keyword);
            
            // Google Analytics ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆ - æ¤œç´¢å®Ÿè¡Œ
            gtag('event', 'search', {
                'event_category': 'user_action',
                'search_term': keyword,
                'event_label': keyword,
                'custom_parameter_1': 'keyword_search'
            });
            
            updateDebugInfo('<strong>ğŸ” æ¤œç´¢ä¸­...</strong> "' + keyword + '" ã§ã‚«ãƒ¬ãƒ¼åº—ã‚’æ¤œç´¢ã—ã¦ã„ã¾ã™');
            
            const request = {
                textQuery: keyword + ' ã‚«ãƒ¬ãƒ¼',
                fields: ['displayName', 'location', 'businessStatus', 'formattedAddress'],
                maxResultCount: 20
            };
            
            const center = map.getCenter();
            if (center) {
                request.locationBias = { lat: center.lat(), lng: center.lng() };
            }
            
            google.maps.places.Place.searchByText(request).then((response) => {
                console.log('æ¤œç´¢çµæœ:', response);
                
                if (response.places && response.places.length > 0) {
                    clearMarkers();
                    response.places.forEach(place => createNewMarker(place));
                    
                    if (response.places[0] && response.places[0].location) {
                        map.setCenter(response.places[0].location);
                        map.setZoom(15);
                    }
                    
                    // Google Analytics - æ¤œç´¢æˆåŠŸã‚¤ãƒ™ãƒ³ãƒˆ
                    gtag('event', 'search_success', {
                        'event_category': 'search_result',
                        'search_term': keyword,
                        'result_count': response.places.length,
                        'event_label': `${keyword} - ${response.places.length}ä»¶`,
                        'custom_parameter_1': 'search_success'
                    });
                    
                    updateDebugInfo(`<strong>âœ… æ¤œç´¢å®Œäº†ï¼</strong> "${keyword}" ã§${response.places.length}ä»¶ã®ã‚«ãƒ¬ãƒ¼åº—ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
                    
                    document.getElementById('searchBox').value = '';
                    
                } else {
                    console.log('æ¤œç´¢çµæœãªã—');
                    
                    // Google Analytics - æ¤œç´¢çµæœãªã—ã‚¤ãƒ™ãƒ³ãƒˆ
                    gtag('event', 'search_no_results', {
                        'event_category': 'search_result',
                        'search_term': keyword,
                        'event_label': keyword,
                        'custom_parameter_1': 'search_no_results'
                    });
                    
                    updateDebugInfo(`<strong>âš ï¸ æ¤œç´¢çµæœãªã—</strong> "${keyword}" ã«è©²å½“ã™ã‚‹ã‚«ãƒ¬ãƒ¼åº—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`);
                }
                
            }).catch((error) => {
                console.error('æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                
                // Google Analytics - æ¤œç´¢ã‚¨ãƒ©ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
                gtag('event', 'search_error', {
                    'event_category': 'error',
                    'search_term': keyword,
                    'error_message': error.message,
                    'event_label': `${keyword} - ã‚¨ãƒ©ãƒ¼`,
                    'custom_parameter_1': 'search_error'
                });
                
                updateDebugInfo(`<strong>âŒ æ¤œç´¢ã‚¨ãƒ©ãƒ¼:</strong> ${error.message}`);
            });
        }
        
        // æ”¹è‰¯ç‰ˆãƒãƒ¼ã‚«ãƒ¼ä½œæˆé–¢æ•°ï¼ˆğŸ›ã‚¢ã‚¤ã‚³ãƒ³ä»˜ãï¼‰
        function createNewMarker(place) {
            console.log('ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆä¸­:', place.displayName);
            
            try {
                const marker = new google.maps.Marker({
                    map: map,
                    position: place.location,
                    title: place.displayName,
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40">
                                <circle cx="20" cy="20" r="18" fill="#ff8c00" stroke="#ffffff" stroke-width="3"/>
                                <text x="20" y="28" font-family="Arial" font-size="20" text-anchor="middle" fill="#ffffff">ğŸ›</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(40, 40),
                        anchor: new google.maps.Point(20, 20)
                    },
                    animation: google.maps.Animation.DROP
                });
                
                const legacyPlace = {
                    name: place.displayName,
                    place_id: place.id || 'new_api_' + Date.now() + '_' + Math.random(),
                    geometry: { location: place.location },
                    vicinity: place.formattedAddress || 'ä½æ‰€ä¸æ˜'
                };
                
                marker.addListener('click', () => {
                    console.log('ãƒãƒ¼ã‚«ãƒ¼ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ:', place.displayName);
                    currentPlace = legacyPlace;
                    showPopup(legacyPlace);
                });
                
                markers.push(marker);
                
            } catch (error) {
                console.error('ãƒãƒ¼ã‚«ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                createSimpleMarker(place);
            }
        }
        
        // ã‚·ãƒ³ãƒ—ãƒ«ãƒãƒ¼ã‚«ãƒ¼ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        function createSimpleMarker(place) {
            const marker = new google.maps.Marker({
                map: map,
                position: place.location,
                title: place.displayName,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 15,
                    fillColor: '#ff8c00',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 3
                }
            });
            
            const legacyPlace = {
                name: place.displayName,
                place_id: place.id || 'simple_' + Date.now(),
                geometry: { location: place.location },
                vicinity: place.formattedAddress || 'ä½æ‰€ä¸æ˜'
            };
            
            marker.addListener('click', () => {
                currentPlace = legacyPlace;
                showPopup(legacyPlace);
            });
            
            markers.push(marker);
        }
        
        // ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
        function clearMarkers() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
        }
        
        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
        function showPopup(place) {
            console.log('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º:', place);
            try {
                document.getElementById('popupTitle').textContent = place.name;
                document.getElementById('popupAddress').textContent = place.vicinity;
                document.getElementById('popupOverlay').style.display = 'block';
            } catch (error) {
                console.error('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
        function closePopup() {
            document.getElementById('popupOverlay').style.display = 'none';
            currentPlace = null;
        }
        
        // ã€Œé£Ÿã¹ãŸã€ã‚’è¨˜éŒ²ï¼ˆå®Ÿç¸¾ãƒã‚§ãƒƒã‚¯ä»˜ã + GAã‚¤ãƒ™ãƒ³ãƒˆï¼‰
        function recordVisit() {
            if (!currentPlace) return;
            
            console.log('è¨˜éŒ²ä¸­:', currentPlace.name);
            
            const log = {
                id: currentPlace.place_id,
                name: currentPlace.name,
                address: currentPlace.vicinity,
                lat: currentPlace.geometry.location.lat(),
                lng: currentPlace.geometry.location.lng(),
                date: new Date().toLocaleString('ja-JP')
            };
            
            curryLogs.push(log);
            localStorage.setItem('curryLogs', JSON.stringify(curryLogs));
            
            // Google Analytics ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆ - ã‚«ãƒ¬ãƒ¼è¨˜éŒ²
            gtag('event', 'curry_logged', {
                'event_category': 'user_action',
                'event_label': currentPlace.name,
                'curry_shop_name': currentPlace.name,
                'curry_shop_address': currentPlace.vicinity,
                'total_visits': curryLogs.length,
                'custom_parameter_1': 'curry_visit'
            });
            
            // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            updateHeatmapData(currentPlace.place_id, log.lat, log.lng);
            
            displayLogs();
            displayHeatmap();
            closePopup();
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            alert('ğŸ› ã‚»ã‚«ã‚«ãƒ¬ã«è¿½åŠ ã•ã‚Œã¾ã—ãŸï¼');
            console.log('è¨˜éŒ²å®Œäº†');
            
            // å®Ÿç¸¾ãƒã‚§ãƒƒã‚¯
            checkAchievements();
        }
        
        // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        function updateHeatmapData(placeId, lat, lng) {
            if (!heatmapData[placeId]) {
                heatmapData[placeId] = { lat, lng, count: 0 };
            }
            heatmapData[placeId].count++;
            localStorage.setItem('heatmapData', JSON.stringify(heatmapData));
        }
        
        // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚’è¡¨ç¤º
        function displayHeatmap() {
            console.log('ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚’è¡¨ç¤ºä¸­...');
            
            // æ—¢å­˜ã®å††ã‚’å‰Šé™¤
            heatmapCircles.forEach(circle => circle.setMap(null));
            heatmapCircles = [];
            
            // å„å ´æ‰€ã«å††ã‚’è¡¨ç¤º
            Object.values(heatmapData).forEach(data => {
                const opacity = Math.min(0.3 + (data.count * 0.15), 0.8);
                const radius = 100 + (data.count * 50);
                
                const circle = new google.maps.Circle({
                    strokeColor: '#ff8c00',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#ff8c00',
                    fillOpacity: opacity,
                    map: map,
                    center: { lat: data.lat, lng: data.lng },
                    radius: radius
                });
                
                heatmapCircles.push(circle);
            });
            
            console.log(`ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ— ${Object.keys(heatmapData).length} ç®‡æ‰€ã‚’è¡¨ç¤º`);
        }
        
        // ãƒ­ã‚°ã‚’è¡¨ç¤º
        function displayLogs() {
            const logList = document.getElementById('logList');
            const logCount = document.getElementById('logCount');
            
            if (curryLogs.length === 0) {
                logList.innerHTML = '<div class="loading">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚åœ°å›³ä¸Šã®ã‚«ãƒ¬ãƒ¼åº—ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è¨˜éŒ²ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼</div>';
                logCount.textContent = '0';
                return;
            }
            
            logCount.textContent = curryLogs.length;
            
            // æœ€æ–°ã®è¨˜éŒ²ã‚’ä¸Šã«è¡¨ç¤º
            const sortedLogs = [...curryLogs].reverse();
            
            logList.innerHTML = sortedLogs.map(log => `
                <div class="log-item">
                    <div class="log-item-name">${log.name}</div>
                    <div class="log-item-date">${log.date} - ${log.address}</div>
                </div>
            `).join('');
        }
        
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’æ›´æ–°
        function updateDebugInfo(html) {
            const debugElement = document.getElementById('debugInfo');
            if (debugElement) {
                debugElement.innerHTML = html;
            }
        }
        
        // å®Ÿç¸¾ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–
        function initAchievements() {
            checkAchievements();
            console.log('å®Ÿç¸¾ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ');
        }
        
        // å®Ÿç¸¾ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
        function checkAchievements() {
            const visitCount = curryLogs.length;
            const uniqueShops = new Set(curryLogs.map(log => log.id)).size;
            const newBadges = [];
            
            // å®Ÿç¸¾ã®å®šç¾©
            const achievementRules = [
                { id: 'first_curry', name: 'ğŸ› ã‚«ãƒ¬ãƒ¼ãƒ‡ãƒ“ãƒ¥ãƒ¼', desc: 'åˆå›ã®ã‚«ãƒ¬ãƒ¼ã‚’è¨˜éŒ²', condition: visitCount >= 1 },
                { id: 'curry_lover', name: 'ğŸ§¡ ã‚«ãƒ¬ãƒ¼å¥½ã', desc: 'ã‚«ãƒ¬ãƒ¼ã‚’5å›è¨˜éŒ²', condition: visitCount >= 5 },
                { id: 'curry_master', name: 'ğŸ‘‘ ã‚«ãƒ¬ãƒ¼ãƒã‚¹ã‚¿ãƒ¼', desc: 'ã‚«ãƒ¬ãƒ¼ã‚’10å›è¨˜éŒ²', condition: visitCount >= 10 },
                { id: 'explorer', name: 'ğŸ—ºï¸ ã‚«ãƒ¬ãƒ¼æ¢æ¤œå®¶', desc: '5åº—èˆ—ã‚’åˆ¶è¦‡', condition: uniqueShops >= 5 },
                { id: 'curry_addict', name: 'ğŸ”¥ ã‚«ãƒ¬ãƒ¼ä¸­æ¯’', desc: 'ã‚«ãƒ¬ãƒ¼ã‚’20å›è¨˜éŒ²', condition: visitCount >= 20 },
                { id: 'shop_hunter', name: 'ğŸ¯ åº—èˆ—ãƒãƒ³ã‚¿ãƒ¼', desc: '10åº—èˆ—ã‚’åˆ¶è¦‡', condition: uniqueShops >= 10 }
            ];
            
            // æ–°ã—ãé”æˆã—ãŸå®Ÿç¸¾ã‚’ãƒã‚§ãƒƒã‚¯
            achievementRules.forEach(rule => {
                if (rule.condition && !achievements[rule.id]) {
                    achievements[rule.id] = {
                        name: rule.name,
                        desc: rule.desc,
                        date: new Date().toLocaleString('ja-JP')
                    };
                    newBadges.push(rule);
                }
            });
            
            // å®Ÿç¸¾ã‚’ä¿å­˜
            localStorage.setItem('achievements', JSON.stringify(achievements));
            
            // æ–°ã—ã„ãƒãƒƒã‚¸ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
            if (newBadges.length > 0) {
                showAchievementPopup(newBadges);
            }
            
            // å®Ÿç¸¾è¡¨ç¤ºã‚’æ›´æ–°
            updateAchievementDisplay();
        }
        
        // å®Ÿç¸¾ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤ºï¼ˆGAã‚¤ãƒ™ãƒ³ãƒˆä»˜ãï¼‰
        function showAchievementPopup(badges) {
            const badgeText = badges.map(badge => `${badge.name}\n${badge.desc}`).join('\n\n');
            
            // Google Analytics - å®Ÿç¸¾é”æˆã‚¤ãƒ™ãƒ³ãƒˆ
            badges.forEach(badge => {
                gtag('event', 'achievement_unlocked', {
                    'event_category': 'gamification',
                    'achievement_id': badge.id,
                    'achievement_name': badge.name,
                    'event_label': badge.name,
                    'custom_parameter_1': 'achievement'
                });
            });
            
            alert(`ğŸ‰ æ–°ã—ã„å®Ÿç¸¾ã‚’é”æˆã—ã¾ã—ãŸï¼\n\n${badgeText}`);
        }
        
        // å®Ÿç¸¾è¡¨ç¤ºã‚’æ›´æ–°
        function updateAchievementDisplay() {
            const visitCount = curryLogs.length;
            const uniqueShops = new Set(curryLogs.map(log => log.id)).size;
            const achievementCount = Object.keys(achievements).length;
            
            // ãƒ­ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«çµ±è¨ˆã‚’è¿½åŠ 
            const logTitle = document.querySelector('.log-title');
            const existingStats = document.getElementById('stats');
            
            if (existingStats) {
                existingStats.remove();
            }
            
            const stats = document.createElement('div');
            stats.id = 'stats';
            stats.style.cssText = 'font-size:12px; color:#666; margin-top:5px;';
            stats.innerHTML = `
                ğŸ“Š ${visitCount}å›è¨ªå• | ğŸª ${uniqueShops}åº—èˆ—åˆ¶è¦‡ | ğŸ† ${achievementCount}å€‹ã®å®Ÿç¸¾é”æˆ
            `;
            
            logTitle.appendChild(stats);
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        function setupEventListeners() {
            // ã€Œé£Ÿã¹ãŸã€ãƒœã‚¿ãƒ³
            document.getElementById('btnAte').addEventListener('click', recordVisit);
            
            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
            document.getElementById('btnClose').addEventListener('click', closePopup);
            document.getElementById('popupOverlay').addEventListener('click', (e) => {
                if (e.target === document.getElementById('popupOverlay')) {
                    closePopup();
                }
            });
            
            // è©³ç´°ã‚’è¦‹ã‚‹
            document.getElementById('btnDetails').addEventListener('click', () => {
                if (currentPlace) {
                    const searchQuery = encodeURIComponent(currentPlace.name);
                    window.open(`https://www.google.com/maps/search/${searchQuery}`, '_blank');
                }
            });
            
            // æ¤œç´¢æ©Ÿèƒ½
            document.getElementById('searchBox').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const query = e.target.value.trim();
                    if (query) {
                        console.log('æ¤œç´¢å®Ÿè¡Œ:', query);
                        searchCurryByKeyword(query);
                    }
                }
            });
        }
        
        // åœ°å›³ã‚’èª­ã¿è¾¼ã¿
        function loadGoogleMaps() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&libraries=places&callback=initMap`;
            script.async = true;
            script.onerror = () => {
                console.error('Google Maps APIã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                updateDebugInfo('âŒ Google Maps APIã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            };
            document.head.appendChild(script);
        }
        
        // åˆæœŸåŒ–å‡¦ç†
        function init() {
            setupEventListeners();
            
            // APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (API_KEY === 'YOUR_API_KEY_HERE') {
                document.getElementById('map').innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f0f0f0; color: #666; text-align: center; padding: 20px;">
                        <div>
                            <h3>APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„</h3>
                            <p>ã‚³ãƒ¼ãƒ‰å†…ã®ã€ŒYOUR_API_KEY_HEREã€ã‚’ã‚ãªãŸã®Google Maps APIã‚­ãƒ¼ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚</p>
                        </div>
                    </div>
                `;
                updateDebugInfo('âŒ APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
            } else {
                loadGoogleMaps();
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', init);
        
        // Google Maps APIã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
        window.initMap = initMap;
    </script>
</body>
</html>
